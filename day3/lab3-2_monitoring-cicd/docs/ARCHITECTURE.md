# Lab 3-2: Architecture Guide

## ğŸ“ ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MLOps Monitoring & CI/CD Architecture                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Production Environment                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚   KServe    â”‚â”€â”€â”€â–ºâ”‚   Metrics   â”‚â”€â”€â”€â–ºâ”‚ Prometheus  â”‚             â”‚   â”‚
â”‚  â”‚  â”‚InferenceServâ”‚    â”‚  Exporter   â”‚    â”‚   Server    â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  ice        â”‚    â”‚  (per user) â”‚    â”‚             â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚        â”‚                                      â”‚                     â”‚   â”‚
â”‚  â”‚        â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚        â”‚              â”‚                                      â”‚     â”‚   â”‚
â”‚  â”‚        â”‚              â–¼                                      â–¼     â”‚   â”‚
â”‚  â”‚        â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚        â”‚       â”‚   Grafana   â”‚                       â”‚   Alert   â”‚â”‚   â”‚
â”‚  â”‚        â”‚       â”‚  Dashboard  â”‚                       â”‚  Manager  â”‚â”‚   â”‚
â”‚  â”‚        â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â”‚        â”‚                                                   â”‚      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                   â”‚          â”‚
â”‚           â”‚                                                   â–¼          â”‚
â”‚           â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚           â”‚                                            â”‚  Webhook  â”‚     â”‚
â”‚           â”‚                                            â”‚  Trigger  â”‚     â”‚
â”‚           â”‚                                            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                                                  â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        â”‚              CI/CD Pipeline (GitHub Actions)      â”‚       â”‚  â”‚
â”‚  â”‚        â”‚                                                   â–¼       â”‚  â”‚
â”‚  â”‚        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚        â”‚        â”‚           Retrain Workflow                   â”‚  â”‚  â”‚
â”‚  â”‚        â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚  â”‚
â”‚  â”‚        â”‚        â”‚  â”‚ Data â”‚â”€â”€â–ºâ”‚ Train â”‚â”€â”€â–ºâ”‚Validateâ”‚          â”‚  â”‚  â”‚
â”‚  â”‚        â”‚        â”‚  â”‚ Prep â”‚   â”‚ Model â”‚   â”‚ Model  â”‚          â”‚  â”‚  â”‚
â”‚  â”‚        â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜          â”‚  â”‚  â”‚
â”‚  â”‚        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚        â”‚                                       â”‚                   â”‚  â”‚
â”‚  â”‚        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚        â”‚        â”‚            CD Workflow       â”‚               â”‚  â”‚  â”‚
â”‚  â”‚        â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”          â”‚  â”‚  â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”‚Build â”‚â”€â”€â–ºâ”‚ Push  â”‚â”€â”€â–ºâ”‚ Deploy â”‚          â”‚  â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚Dockerâ”‚   â”‚  ECR  â”‚   â”‚ KServe â”‚          â”‚  â”‚  â”‚
â”‚  â”‚                 â”‚  â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚  â”‚
â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ë°ì´í„° íë¦„

### 1. ëª¨ë‹ˆí„°ë§ íë¦„

```
KServe Model â†’ Metrics Exporter â†’ Prometheus â†’ Grafana
                     â”‚                â”‚
                     â”‚                â–¼
                     â”‚           Alert Rules
                     â”‚                â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â–º Alert Manager
```

### 2. CI/CD íë¦„

```
Code Push â†’ GitHub Actions CI â†’ Test â†’ Build â†’ GitHub Actions CD â†’ Deploy
                                         â”‚
                                         â–¼
                                    ECR Registry
```

### 3. ìë™ ì¬í•™ìŠµ íë¦„

```
Prometheus Alert â†’ Alert Manager â†’ Webhook â†’ GitHub Actions Retrain
       â”‚                                              â”‚
       â”‚                                              â–¼
       â”‚                                    Train New Model
       â”‚                                              â”‚
       â”‚                                              â–¼
       â”‚                                    Validate Model
       â”‚                                              â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
                                                      â–¼
                                              Deploy New Model
```

---

## ğŸ“¦ ì»´í¬ë„ŒíŠ¸ ìƒì„¸

### Metrics Exporter

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ì—­í• ** | ëª¨ë¸ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìƒì„± ë° ë…¸ì¶œ |
| **ë°°í¬ ìœ„ì¹˜** | ê° ì‚¬ìš©ì ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (kubeflow-userXX) |
| **í¬íŠ¸** | 8000 |
| **ë©”íŠ¸ë¦­** | model_mae_score, model_r2_score, model_prediction_total, model_prediction_latency |

### Prometheus

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ì—­í• ** | ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì €ì¥ |
| **ë°°í¬ ìœ„ì¹˜** | monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ |
| **í¬íŠ¸** | 9090 |
| **ë°ì´í„° ë³´ì¡´** | 15ì¼ |

### Grafana

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ì—­í• ** | ëŒ€ì‹œë³´ë“œ ì‹œê°í™” |
| **ë°°í¬ ìœ„ì¹˜** | monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ |
| **í¬íŠ¸** | 3000 |
| **ê³„ì •** | user01~user15, user20 (ë¹„ë°€ë²ˆí˜¸: mlops2025!) |

### Alert Manager

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ì—­í• ** | Alert ë¼ìš°íŒ… ë° ì•Œë¦¼ |
| **ë°°í¬ ìœ„ì¹˜** | monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ |
| **í¬íŠ¸** | 9093 |

---

## ğŸ“Š ë©”íŠ¸ë¦­ ìƒì„¸

### model_mae_score (Gauge)

```
model_mae_score{
    model_name="california-housing",
    version="v1.0",
    user_id="user01",
    namespace="kubeflow-user01"
}
```

- **ì„¤ëª…**: í˜„ì¬ ëª¨ë¸ì˜ Mean Absolute Error
- **ì •ìƒ ë²”ìœ„**: 0.30 ~ 0.45
- **Alert ì„ê³„ê°’**: > 0.45

### model_r2_score (Gauge)

```
model_r2_score{
    model_name="california-housing",
    version="v1.0",
    user_id="user01",
    namespace="kubeflow-user01"
}
```

- **ì„¤ëª…**: í˜„ì¬ ëª¨ë¸ì˜ RÂ² Score
- **ì •ìƒ ë²”ìœ„**: 0.75 ~ 0.95
- **Alert ì„ê³„ê°’**: < 0.75

### model_prediction_total (Counter)

```
model_prediction_total{
    model_name="california-housing",
    version="v1.0",
    user_id="user01",
    namespace="kubeflow-user01",
    status="success|error"
}
```

- **ì„¤ëª…**: ëˆ„ì  ì˜ˆì¸¡ íšŸìˆ˜
- **ì‚¬ìš©**: ì²˜ë¦¬ëŸ‰ ê³„ì‚° (`rate()`)

### model_prediction_latency (Histogram)

```
model_prediction_latency_bucket{
    model_name="california-housing",
    version="v1.0",
    user_id="user01",
    namespace="kubeflow-user01",
    le="0.01|0.05|0.1|..."
}
```

- **ì„¤ëª…**: ì˜ˆì¸¡ ì§€ì—°ì‹œê°„ ë¶„í¬
- **ì‚¬ìš©**: ë°±ë¶„ìœ„ìˆ˜ ê³„ì‚° (`histogram_quantile()`)

---

## ğŸš€ GitHub Actions ì›Œí¬í”Œë¡œìš°

### CI Pipeline (ci-test.yaml)

```yaml
Trigger: push to main/develop, PR to main

Jobs:
  1. lint      - ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (flake8, black, isort)
  2. test      - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (pytest, coverage)
  3. model-test - ëª¨ë¸ í•™ìŠµ/ì¶”ë¡  í…ŒìŠ¤íŠ¸
  4. docker-build - Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸
```

### CD Pipeline (cd-deploy.yaml)

```yaml
Trigger: CI ì„±ê³µ í›„ ìë™ ì‹¤í–‰

Jobs:
  1. build-and-push  - Docker ë¹Œë“œ â†’ ECR í‘¸ì‹œ
  2. deploy-kserve   - KServe InferenceService ë°°í¬
  3. verify-deployment - í—¬ìŠ¤ ì²´í¬
  4. notify          - ë°°í¬ ê²°ê³¼ ì•Œë¦¼
```

### Retrain Pipeline (retrain-model.yaml)

```yaml
Trigger: workflow_dispatch (ìˆ˜ë™/API)

Jobs:
  1. prepare-data    - í•™ìŠµ ë°ì´í„° ì¤€ë¹„
  2. retrain         - ëª¨ë¸ ì¬í•™ìŠµ
  3. validate        - ìƒˆ ëª¨ë¸ ê²€ì¦
  4. trigger-deploy  - CD íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±°
```

---

## ğŸ”” Alert íë¦„

### Alert ë°œìƒ â†’ ì¬í•™ìŠµ íŠ¸ë¦¬ê±°

```
1. Prometheus: model_mae_score > 0.45 ê°ì§€
      â”‚
      â–¼
2. Alert Rule: "ModelDriftDetected" í™œì„±í™” (5ë¶„ ìœ ì§€)
      â”‚
      â–¼
3. Alert Manager: Alert ìˆ˜ì‹ 
      â”‚
      â–¼
4. Webhook: GitHub API í˜¸ì¶œ (workflow_dispatch)
      â”‚
      â–¼
5. GitHub Actions: retrain-model.yaml ì‹¤í–‰
      â”‚
      â–¼
6. ìƒˆ ëª¨ë¸ í•™ìŠµ â†’ ê²€ì¦ â†’ ë°°í¬
```

### Webhook ì„¤ì • (Alert Manager â†’ GitHub)

```yaml
# alertmanager.yml
receivers:
  - name: 'github-retrain'
    webhook_configs:
      - url: 'https://api.github.com/repos/ORG/REPO/dispatches'
        http_config:
          authorization:
            type: Bearer
            credentials: $GITHUB_TOKEN
        send_resolved: false
```

---

## ğŸ›¡ï¸ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **GitHub Secrets**
   - `AWS_ACCESS_KEY_ID`
   - `AWS_SECRET_ACCESS_KEY`
   - `GITHUB_TOKEN` (workflow_dispatch ìš©)

2. **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬**
   - ê° ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ë§Œ ì ‘ê·¼
   - Network Policyë¡œ ê²©ë¦¬

3. **Grafana ê¶Œí•œ**
   - ì‚¬ìš©ìë³„ ê³„ì •ìœ¼ë¡œ ìì‹ ì˜ ë©”íŠ¸ë¦­ë§Œ ì¡°íšŒ ê¶Œì¥

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Prometheus Documentation](https://prometheus.io/docs/)
- [Grafana Documentation](https://grafana.com/docs/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [KServe Documentation](https://kserve.github.io/website/)
