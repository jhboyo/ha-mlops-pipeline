apiVersion: v1
kind: ConfigMap
metadata:
  name: metrics-exporter-script
  namespace: monitoring
data:
  metrics_exporter.py: |
    #!/usr/bin/env python3
    """
    Lab 3-2 Part 2: Custom Metrics Exporter
    모델 성능 메트릭을 Prometheus 형식으로 노출합니다.
    """
    
    import time
    import random
    from prometheus_client import start_http_server, Gauge, Counter, Histogram, Info
    import numpy as np
    
    # ============================================================
    # Prometheus Metrics 정의
    # ============================================================
    
    # Gauge: 증가/감소 가능한 메트릭
    model_mae_score = Gauge(
        'model_mae_score',
        'Current Mean Absolute Error of the model',
        ['model_name', 'version']
    )
    
    model_r2_score = Gauge(
        'model_r2_score',
        'Current R² Score of the model',
        ['model_name', 'version']
    )
    
    model_accuracy_score = Gauge(
        'model_accuracy_score',
        'Current accuracy score',
        ['model_name', 'version']
    )
    
    # Counter: 증가만 가능한 메트릭
    model_prediction_total = Counter(
        'model_prediction_total',
        'Total number of predictions',
        ['model_name', 'version', 'status']
    )
    
    model_prediction_errors = Counter(
        'model_prediction_errors_total',
        'Total number of prediction errors',
        ['model_name', 'version', 'error_type']
    )
    
    # Histogram: 분포 측정 메트릭
    model_prediction_latency = Histogram(
        'model_prediction_latency',
        'Prediction latency in seconds',
        ['model_name', 'version'],
        buckets=(0.01, 0.025, 0.05, 0.075, 0.1, 0.25, 0.5, 0.75, 1.0, 2.5, 5.0)
    )
    
    # Info: 정적 정보
    model_info = Info(
        'model_version_info',
        'Information about the model version'
    )
    
    
    # ============================================================
    # 메트릭 시뮬레이션 함수
    # ============================================================
    
    def simulate_model_a_metrics():
        """Model A (v1.0) 메트릭 시뮬레이션"""
        # MAE: 0.38 ~ 0.46 (점차 증가 - 성능 저하)
        base_mae = 0.38
        drift_factor = time.time() % 600 / 600  # 10분 주기로 증가
        mae = base_mae + (0.08 * drift_factor) + np.random.normal(0, 0.02)
        model_mae_score.labels(model_name='california-housing', version='v1.0').set(mae)
        
        # R² Score: 0.80 ~ 0.85
        r2 = 0.85 - (0.05 * drift_factor) + np.random.normal(0, 0.01)
        model_r2_score.labels(model_name='california-housing', version='v1.0').set(r2)
        
        # Accuracy: 75% ~ 82%
        accuracy = 0.82 - (0.07 * drift_factor) + np.random.normal(0, 0.02)
        model_accuracy_score.labels(model_name='california-housing', version='v1.0').set(accuracy)
        
        # 예측 요청 (성공)
        if random.random() > 0.01:  # 99% 성공률
            model_prediction_total.labels(
                model_name='california-housing',
                version='v1.0',
                status='success'
            ).inc()
        else:
            model_prediction_total.labels(
                model_name='california-housing',
                version='v1.0',
                status='error'
            ).inc()
            model_prediction_errors.labels(
                model_name='california-housing',
                version='v1.0',
                error_type='timeout'
            ).inc()
        
        # 응답 시간: 40ms ~ 55ms
        latency = 0.040 + np.random.exponential(0.010)
        model_prediction_latency.labels(
            model_name='california-housing',
            version='v1.0'
        ).observe(latency)
    
    
    def simulate_model_b_metrics():
        """Model B (v2.0) 메트릭 시뮬레이션"""
        # MAE: 0.34 ~ 0.39 (안정적)
        mae = 0.36 + np.random.normal(0, 0.015)
        model_mae_score.labels(model_name='california-housing', version='v2.0').set(mae)
        
        # R² Score: 0.86 ~ 0.90
        r2 = 0.88 + np.random.normal(0, 0.01)
        model_r2_score.labels(model_name='california-housing', version='v2.0').set(r2)
        
        # Accuracy: 84% ~ 88%
        accuracy = 0.86 + np.random.normal(0, 0.01)
        model_accuracy_score.labels(model_name='california-housing', version='v2.0').set(accuracy)
        
        # 예측 요청 (성공)
        if random.random() > 0.005:  # 99.5% 성공률 (Model A보다 안정적)
            model_prediction_total.labels(
                model_name='california-housing',
                version='v2.0',
                status='success'
            ).inc()
        else:
            model_prediction_total.labels(
                model_name='california-housing',
                version='v2.0',
                status='error'
            ).inc()
            model_prediction_errors.labels(
                model_name='california-housing',
                version='v2.0',
                error_type='timeout'
            ).inc()
        
        # 응답 시간: 45ms ~ 60ms (Model A보다 약간 느림)
        latency = 0.048 + np.random.exponential(0.012)
        model_prediction_latency.labels(
            model_name='california-housing',
            version='v2.0'
        ).observe(latency)
    
    
    def update_model_info():
        """모델 정보 업데이트"""
        model_info.info({
            'model_name': 'california-housing',
            'framework': 'scikit-learn',
            'framework_version': '1.3.2',
            'python_version': '3.9',
            'model_type': 'RandomForestRegressor',
            'training_date': '2024-12-09'
        })
    
    
    # ============================================================
    # Main Loop
    # ============================================================
    
    def main():
        """메트릭 수집 서버 시작"""
        print("=" * 60)
        print("  Custom Metrics Exporter")
        print("=" * 60)
        print("")
        print("Starting Prometheus metrics server on port 8000...")
        
        # Prometheus HTTP 서버 시작
        start_http_server(8000)
        print("✅ Metrics server started: http://localhost:8000/metrics")
        print("")
        print("Simulating A/B test traffic...")
        print("  Model A (v1.0): Baseline with gradual performance degradation")
        print("  Model B (v2.0): Improved model with stable performance")
        print("")
        print("Press Ctrl+C to stop")
        print("")
        
        # 모델 정보 설정 (한 번만)
        update_model_info()
        
        # 메트릭 생성 루프
        request_count = 0
        try:
            while True:
                # Model A와 Model B에 대해 메트릭 생성
                # 50/50 트래픽 분배 시뮬레이션
                simulate_model_a_metrics()
                simulate_model_b_metrics()
                
                request_count += 2
                
                # 30초마다 상태 출력
                if request_count % 60 == 0:
                    elapsed_time = request_count / 2  # 초당 1회 * 2모델
                    print(f"[{int(elapsed_time):04d}s] Generated {request_count} metric updates")
                
                # 1초 대기 (초당 2개 요청 시뮬레이션)
                time.sleep(1.0)
                
        except KeyboardInterrupt:
            print("")
            print("=" * 60)
            print("  Metrics Exporter Stopped")
            print("=" * 60)
            print(f"Total metric updates: {request_count}")
    
    
    if __name__ == '__main__':
        main()
