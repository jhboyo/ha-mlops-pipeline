# ============================================================
# Lab 2-3: KServe InferenceService 템플릿
# ============================================================
# 
# ⚠️ 사용 전 환경 변수 설정 필요:
#   export USER_NUM="01"  # 본인 번호
#   export NAMESPACE="kubeflow-user${USER_NUM}"
#   export S3_BUCKET="mlops-training-user${USER_NUM}"
#
# 사용법:
#   # envsubst로 환경 변수 치환 후 적용
#   envsubst < inferenceservice.yaml | kubectl apply -f -
#
# S3 모델 경로 확인:
#   aws s3 ls s3://${S3_BUCKET}/mlflow-artifacts/ --recursive | grep MLmodel
# ============================================================

apiVersion: serving.kserve.io/v1beta1
kind: InferenceService
metadata:
  name: california-model
  # ⚠️ 사용자별 네임스페이스 (envsubst로 자동 치환)
  namespace: ${NAMESPACE}
  labels:
    user: user${USER_NUM}
  annotations:
    # ⚠️ 중요: Istio sidecar 비활성화 (RBAC 403 에러 방지)
    sidecar.istio.io/inject: "false"
spec:
  predictor:
    # 서버리스 스케일링 설정 (선택사항)
    minReplicas: 0
    maxReplicas: 1
    scaleTarget: 1
    scaleMetric: concurrency
    
    model:
      # 모델 형식
      modelFormat:
        name: sklearn
      
      # ⚠️ 중요: S3 전체 경로 사용!
      # mlflow-artifacts:/RUN_ID/model 형식은 지원되지 않음
      # 
      # 형식: s3://mlops-training-user${USER_NUM}/mlflow-artifacts/RUN_ID/artifacts/model
      #
      # ⚠️ EXPERIMENT_ID와 RUN_ID는 실제 값으로 교체 필요!
      # S3에서 확인: aws s3 ls s3://${S3_BUCKET}/mlflow-artifacts/ --recursive | grep MLmodel
      storageUri: "s3://${S3_BUCKET}/mlflow-artifacts/RUN_ID/artifacts/model"
      
      # 리소스 설정
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "1"
          memory: "2Gi"


# ============================================================
# 참고: AWS 자격증명 Secret (이미 생성되어 있어야 함)
# ============================================================
# 아래 명령어로 생성:
#
# export USER_NUM="01"
# export NAMESPACE="kubeflow-user${USER_NUM}"
#
# kubectl create secret generic aws-s3-credentials \
#   --from-literal=AWS_ACCESS_KEY_ID="YOUR_KEY" \
#   --from-literal=AWS_SECRET_ACCESS_KEY="YOUR_SECRET" \
#   --from-literal=AWS_DEFAULT_REGION="ap-northeast-2" \
#   -n ${NAMESPACE}
#
# 또는 scripts/setup_credentials.sh 실행
# ============================================================
